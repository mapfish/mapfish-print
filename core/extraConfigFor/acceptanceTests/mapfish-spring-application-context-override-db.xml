<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd">

    <!-- Use hibernate instead of the registry to store the job queue. configure the data source as well  -->
    <bean id="jobQueue" class="org.mapfish.print.servlet.job.impl.hibernate.HibernateJobQueue"/>
    <bean id="mfDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="org.postgresql.Driver"/>
        <property name="jdbcUrl" value="jdbc:postgresql://${db.host}:${db.port:5432}/${db.name}"/>
        <property name="user" value="${db.username}"/>
        <property name="password" value="${db.password}"/>
        <property name="minPoolSize" value="1"/>
        <property name="numHelperThreads" value="1"/>
        <property name="maxIdleTime" value="30"/>
    </bean>

    <!-- Force the job manager the support clustering, by not taking submitted jobs automatically as its own.
         This mode requires the hibernate job queue, the registry job queue is unsupported.
         oldFileCleanUp should be turned off if hibernate is used for print job results (see below)  -->
    <bean class="org.springframework.beans.factory.config.PropertyOverrideConfigurer">
        <property name="ignoreResourceNotFound" value="true"/>
        <property name="properties">
            <props>
                <prop key="jobManager.clustered">true</prop>
                <prop key="jobManager.oldFileCleanUp">false</prop>
            </props>
        </property>
    </bean>

    <!-- Use hibernate to read and write print job results  -->
    <bean id="printJobPrototype" class="org.mapfish.print.servlet.job.impl.hibernate.HibernatePrintJob"
          scope="prototype"/>
    <bean id="fileReportLoader" class="org.mapfish.print.servlet.job.impl.hibernate.HibernateReportLoader"/>
    <bean id="accounting" class="org.mapfish.print.servlet.job.HibernateAccounting" lazy-init="false"/>

    <bean name="bcryptEncoder"
          class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"/>

    <security:authentication-manager alias="authenticationManager">
        <security:authentication-provider>
            <security:password-encoder ref="bcryptEncoder"/>
            <security:user-service>
                <!-- password is jimi -->
                <security:user name="jimi"
                               password="$2a$10$OeKmMfVmL2IbF/3skK8l2.Gl3EqvvGhb.Pxr/K0dN7.ttPRHsOzVW"
                               authorities="ROLE_USER, ROLE_ADMIN"/>
                <!-- password is bob -->
                <security:user name="bob"
                               password="$2a$10$D5gwUewQQSpjfZPTcj9rpuTTfmxAqNEyJ19pzC7Z9.fHSCl3jtDj."
                               authorities="ROLE_USER"/>
            </security:user-service>
        </security:authentication-provider>
    </security:authentication-manager>
</beans>
